name: CI/CD Pipeline for Spring Boot (Gradle)

# âœ… `deploy` ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
on:
  push:
    branches:
      - deploy
  pull_request:
    branches:
      - deploy

jobs:
  # ğŸ¯ 1ï¸âƒ£ Build & Test Job
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # ğŸ“Œ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸ“Œ í˜„ì¬ ë””ë ‰í† ë¦¬ í™•ì¸ (ë””ë²„ê¹…ìš©)
      - name: Print Current Directory
        run: pwd && ls -l

      # ğŸ“Œ Java í™˜ê²½ ì„¤ì •
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'  # OpenJDK
          java-version: '17'       # Java 17 ì‚¬ìš©

      # ğŸ“Œ Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant Execute Permission for Gradlew
        run: chmod +x backend/gradlew

      # ğŸ“Œ Gradle ì˜ì¡´ì„± ìºì‹± (ì†ë„ ìµœì í™”)
      - name: Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      # SECRET.yml íŒŒì¼ ìƒì„±
      - name: Create SECRET.yml
        run: |
          echo "${{ secrets.SECRET_YML }}" > backend/src/main/resources/SECRET.yml
          chmod 644 backend/src/main/resources/SECRET.yml

      # ğŸ“Œ Gradle ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Build and Test
        run: cd backend && ./gradlew clean build

  # ğŸ¯ 2ï¸âƒ£ Deploy Job
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test  # âœ… ë¹Œë“œ & í…ŒìŠ¤íŠ¸ ì„±ê³µ ì‹œ ì‹¤í–‰
    if: github.ref == 'refs/heads/deploy'  # âœ… `deploy` ë¸Œëœì¹˜ì—ì„œ ì‹¤í–‰
    steps:
      # ğŸ“Œ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸ“Œ GitHub Secretsë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
      - name: Set Up Environment Variables
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: echo "Environment variables set."

      # í™˜ê²½ ë³€ìˆ˜ ì ê²€
      - name: Debug SSH Connection Variables
        run: |
          echo "SERVER_USER: $SERVER_USER"
          echo "SERVER_IP: $SERVER_IP"
          echo "DEPLOY_KEY: $DEPLOY_KEY"

      # ğŸ“Œ SSH í‚¤ ìƒì„± ë° ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ 
      - name: Configure SSH Key
        run: |
          echo "${{ secrets.DEPLOY_KEY }}" | awk '{print $0 "\n"}' > japan_academy.pem
          chmod 600 japan_academy.pem    
          ssh -i japan_academy.pem -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "echo Connected!"

      # ğŸ“Œ ğŸ“¦ ë¹Œë“œëœ `.jar` íŒŒì¼ì„ ì„œë²„ë¡œ ë³µì‚¬ (ë°±ì—”ë“œë§Œ ë°°í¬)
      - name: Deploy JAR to Server
        run: |
          scp -i deploy_key.pem backend/build/libs/*.jar $SERVER_USER@$SERVER_IP:~/academy/backend/app.jar

      # ğŸ“Œ ì›ê²© ì„œë²„ì—ì„œ ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ í›„ ìƒˆ JAR ì‹¤í–‰
      - name: Restart Application
        run: |
          ssh -i deploy_key.pem $SERVER_USER@$SERVER_IP <<EOF
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            PID=\$(ps aux | grep 'app.jar' | grep -v grep | awk '{print \$2}')
            if [ ! -z "\$PID" ]; then
              echo "Stopping existing application with PID: \$PID"
              kill -9 \$PID
            fi
            
            # ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
            echo "Starting new application..."
            nohup java -jar ~/academy/backend/app.jar > ~/academy/backend/nohup.out 2>&1 &
          EOF
